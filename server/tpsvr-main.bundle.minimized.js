!function e(t,n,r){function i(a,s){if(!n[a]){if(!t[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[a]={exports:{}};t[a][0].call(u.exports,(function(e){return i(t[a][1][e]||e)}),u,u.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(require,module,exports){module.exports=function(target,argv,workPath,shortKey){var i,k,v;for(target||(target={}),argv||(argv=process.argv),workPath||!1===workPath||(workPath=process.cwd()),i=0;i<argv.length;i++){if("--"!==(k=argv[i]).slice(0,2)){if(!shortKey||!(k in shortKey))continue;k=shortKey[k]}else k=k.slice(2);!(v=argv[i+1])||"--"===v.slice(0,2)||shortKey&&v in shortKey?target[k]=null:("{"==v.charAt(0)&&"}"==v.slice(-1)?v=eval("("+v+")"):workPath&&v.match(/^\.\.?(\\|\/|$)/)&&(v=workPath+"/"+v),"config"===k?Object.assign(target,"string"==typeof v?require(v):v):target[k]=v,i++)}return target}},{}],2:[function(e,t,n){var r=new Map,i=function(e){if(r.has(e)){var t=r.get(e);return r.delete(e),t}};t.exports=n=function(e,t,n,o){var a,s,l;if(e instanceof Array&&(a=e[0],!(s=e[1])))throw"delaySetTimeout emitter fail, event name empty.";if(n&&(l=i(n),clearTimeout(n)),o){var c=(new Date).getTime()+o;(!l||c<l)&&(l=c)}if(l){var u=l-(new Date).getTime();u<t&&(t=u)}var p=arguments.length>4?Array.prototype.slice.call(arguments,4):null;return a&&(p||(p=[])).unshift(s),n=setTimeout((function(){i(n),a?a.emit.apply(a,p):p?e.apply(null,p):e()}),t),l&&r.set(n,l),n},n.clearFinalTime=i},{}],3:[function(e,t,n){t.exports={http_ip:"127.0.0.1",http_port:8070,mime:{"*":"text/plain",html:"text/html",htm:"text/html",jpg:"image/jpg",css:"text/css",js:"text/javascript",bat:"text/bat",txt:"text/plain",md:"text/x-markdown"},head_text:"<style>a{display:block;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;text-decoration:none;}a:hover{text-decoration:underline;}div{column-width:10em;}</style>"}},{}],4:[function(e,t,n){var r=e("http"),i=e("fs"),o=e("path"),a=e(3),s=function(e,t,n){var{filePath:r,isRoot:a}=n;return r||(r=decodeURIComponent(new URL(e.url,"http://any/").pathname),console.log("browse: "+r),a="/"===r,r=n.root_path+r),r.match(/[\\\/]$/)?(i.readdir(r,{withFileTypes:!0},(function(e,r){if(e)return console.log(e),t.writeHead(500,{"Content-type":"text/plain;charset=UTF-8"}),void t.end(""+e);var i=r.map((e=>{var t=e.isDirectory()?"/":"";return"<a href='"+e.name+t+"'>"+t+e.name+"</a>"}));t.writeHead(200,{"Content-type":"text/html;charset=UTF-8"}),t.end(n.head_text+"<div>"+(a?"":"<a href='../'>/..</a>")+i.join("")+"</div>")})),!0):(i.readFile(r,(function(e,i){if(e)"ENOENT"===e.code?(t.writeHead(404,{"Content-type":"text/plain"}),t.end("404 NOT FOUND")):(console.log(e),t.writeHead(500,{"Content-type":"text/plain;charset=UTF-8"}),t.end(""+e));else{var a=n.mime;t.writeHead(200,{"Content-type":a[o.extname(r).toLowerCase().slice(1)]||a["*"]||"application/octet-stream"}),t.end(i)}})),!0)};t.exports=function(e){var t=Object.assign(Object.create(a),e||{});["mime"].map((n=>{t[n]=Object.assign(Object.create(a[n]),e&&e[n]||{})})),t.root_path||(t.root_path=process.cwd());var n=t.extension||[],i=t.extension_default_process||s;t.default_process=i,console.log("=".repeat(50)),console.log("http://"+t.http_ip+":"+t.http_port+", start at "+new Date),console.log("root: "+t.root_path),r.createServer((function(e,r){for(var o in n)if(n[o](e,r,t))return;i(e,r,t)})).listen(t.http_port,t.http_ip)}},{3:3,undefined:void 0}],5:[function(e,t,n){var r=e("path"),i=e("child_process"),o=e(7),a=e(11),s=e(6),l={},c={},u=function(e,t){return t?(t.nameList="string"==typeof e?[e]:e,o(l,e,t)):void 0===t?o(l,e):void o(l,e,t,!0)},p=function(e,t){var n=o(c,e);if(void 0===t)return n?n.toString():null;null===t?n&&n.clear():(n||o(c,e,n=a()),n.add(t))},d=function(e){var t=u(e);return t?(t.process.stdin.end(),s.kill(t.process.pid),!0):Error("spawn not exists, "+e)};t.exports={spawnData:l,spawnItem:u,historyConsole:p,start:function(e,t,n,o,s){var l=u(e);if(l){var c="spawn already started, "+e;return console.log(c),Error(c)}return o||(o={}),"cwd"in o||(o.cwd=r.dirname(t)),"shell"in o||(o.shell=!0),(l={console:a([t+(n?" ["+n.join(", ")+"]":""),""],{maxLineNumber:o.maxConsoleLineNumber}),commandPath:t,options:o}).process=i.spawn(t,n,o),l.process.stdout.on("data",(t=>{var n=t.toString();l.console.add(n),console.log(e+": "+n.replace(/\s+$/,""))})),l.process.stderr.on("data",(t=>{var n=t.toString();l.console.add(n,"stderr: "),console.error(e+", stderr: "+n.replace(/\s+$/,""))})),l.process.on("close",(t=>{console.log("spawn closed with code "+t+", pid="+l.process.pid+", "+e),o.keepHistoryConsole&&l&&l.console&&!l.console.isEmpty()&&(p(e,[""]),p(e,l.console),p(e,["-----(exited, ["+e+"])-----",""])),u(e,null),s&&s("exit")})),u(e,l),s&&s("start"),l},stop:d,remove:function(e){var t=u(e);return t&&t.options&&(t.options.keepHistoryConsole=!1),o(c,e,null,!0),d(e)},getConsole:function(e,t,n){return t&&"auto"!=t?p(e):(n||(n=u(e)),n?n.console?n.console.toString():null:t?p(e):null)}}},{11:11,6:6,7:7,undefined:void 0}],6:[function(e,t,n){var r=e("child_process"),i=e(11),o="win"===process.platform.slice(0,3),a=function(e,t){if("function"!=typeof t)throw Error("getPidDescendant require callback function");e||(e=o?0:1),e=e.toString();var n=o?r.spawn("wmic.exe",["PROCESS","GET","Name,ParentProcessId,ProcessId"]):r.spawn("ps",["-A","-o","ppid,pid,stat,comm"]),a=!0,s={},l=[],c=i((function(t){if(n&&t){var r=t.trim().split(/(\s+)/);if(a)a=!1;else{var i=o?[r[r.length-3],r[r.length-1],r.slice(0,-4).join("")]:[r[0],r[2],r.slice(6).join(""),r[4]],c=i[0];if(c!=i[1]){var u=c in s?s[c]:s[c]=[];u[u.length]=i}i[1]==e&&l.push(i)}}}));c.lineSplitter=/[\r\n]+/,n.stdout.on("data",(e=>{c.add(e.toString())})),n.stdout.on("close",(r=>{if(n){c.end();for(var i,o=l.length-1;e;)(i=s[e])&&Array.prototype.push.apply(l,i),o++,e=l[o]&&l[o][1];t(null,l)}}))};t.exports=n=a,n.COLUMN_COUNT=4,n.INDEX_PPID=0,n.INDEX_PID=1,n.INDEX_NAME=2,n.INDEX_STAT=3,n.kill=function(e,t){a(e,(function(e,n){if(e)console.log(e);else for(var r=0;r<n.length;r++)process.kill(n[r][1],t)}))}},{11:11,undefined:void 0}],7:[function(e,t,n){t.exports=function(e,t,n,r){"string"==typeof t&&(t=[t]);var i,o,a,s=t.length-1;for(i=0;i<s;i++)(a=e[o=t[i]])||(a=e[o]={}),e=a;if(!r)return void 0!==n?e[t[s]]=n:e[t[s]];delete e[t[s]]}},{}],8:[function(e,t,n){var r=e("events"),i=e(10),o=new r;function a(e,t,n){n||(n={}),n.ACTIVE_PULSE_SECONDS=n.ACTIVE_PULSE_SECONDS||20,n.ACTIVE_PULSE_SECONDS_DELAY=n.ACTIVE_PULSE_SECONDS_DELAY||35,n.ACTIVE_PULSE_MAX_COUNT=n.ACTIVE_PULSE_MAX_COUNT||1e3;var r=n.eventEmitter||o;console.log("state polling start"),e.setHeader("Connection","Keep-Alive"),e.setHeader("Keep-Alive","timeout="+n.ACTIVE_PULSE_SECONDS_DELAY),e.writeHead(200,{"Content-type":"text/plain;charset=UTF-8"}),e.write("/");var a=null,s=null,l=function(){if(a&&(clearTimeout(a),a=!1),s&&(r.removeListener("state-change",s),s=null),!e.writableEnded)try{e.end("\n"+i(t,n.userKey))}catch(e){}console.log("state polling finished")};e.setTimeout(1e3*n.ACTIVE_PULSE_SECONDS_DELAY,l),e.on("close",l),e.on("error",l);var c=0,u=function(){(a||null===a)&&(e.writableEnded||(e.write("/"),++c>n.ACTIVE_PULSE_MAX_COUNT?l():(a&&(clearTimeout(a),a=null),a=setTimeout(u,1e3*n.ACTIVE_PULSE_SECONDS))))};u(),s=l,r.once("state-change",s)}t.exports=n=a,n.longPollingState=a,n.defaultEventEmitter=o,n.getCurrent=function(e,t,n){var r=i(t,n&&n.userKey);e.writeHead(200,{"Content-type":"text/plain;charset=UTF-8"}),e.end("//\n"+r)}},{10:10,undefined:void 0}],9:[function(e,t,n){var r=function(e,t,n,r){e.writeHead(n||200,r||{"Content-Type":"text/plain;charset=UTF-8"}),e.end(t)},i=function(e,t,n,i){r(e,JSON.stringify(t),n,i||{"Content-Type":"text/json;charset=UTF-8"})},o=function(e,t,n,i){var o;o="object"!=typeof t?t:t instanceof Error?t.message:JSON.stringify(t),r(e,o,n||500,i)};t.exports={text:r,json:i,error:o,errorOrData:function(e,t,n,r,a){t?o(e,t,r,a):i(e,n,r,a)}}},{}],10:[function(e,t,n){t.exports=function(e){var t=typeof e;return"function"===t&&(t=typeof(e=e.apply(null,Array.prototype.slice.call(arguments,1)))),"string"===t?e:JSON.stringify(e)}},{}],11:[function(e,t,n){function r(e,t){!e||t||e instanceof Array||(t=e,e=null),this.lineArray=e||[];var n=typeof t;"function"===n?this.lineCallback=t:"number"===n?this.maxLineNumber=t:t&&(t.lineCallback&&(this.lineCallback=t.lineCallback),t.maxLineNumber&&(this.lineCallback=t.maxLineNumber))}r.prototype={lineArray:null,maxLineNumber:255,lastLinePrefix:"",lineCallback:null,lineSplitter:/\r\n|\n\r|\n|\r/,addText:function(e,t){t=t||"";var n=this.lineArray,r=this.lineCallback;n.length<1&&(n[0]=t,t&&(this.lastLinePrefix=t));var i=e.split(this.lineSplitter);t===this.lastLinePrefix?n[n.length-1]=n[n.length-1]+i[0]:(r&&r(n[n.length-1]),n[n.length]=t+i[0],this.lastLinePrefix=t);var o,a,s=i.length-1;if(s>0)for(r&&r(n[n.length-1]),o=1;o<=s;o++)n[n.length]=a=t?t+i[o]:i[o],r&&o!=s&&r(a);n.length>this.maxLineNumber&&n.splice(0,n.length-this.maxLineNumber)},addLine:function(e,t){e instanceof r?e=e.lineArray:e instanceof Array||(e=[e]),t=t||"";var n=this.lineArray,i=this.lineCallback;i&&n.length>0&&i(n[n.length-1]);for(var o,a=e.length-1,s=0;s<=a;s++)n[n.length]=o=t?t+e[s]:e[s],i&&s!=a&&i(o);(t||this.lastLinePrefix)&&(this.lastLinePrefix=t),n.length>this.maxLineNumber&&n.splice(0,n.length-this.maxLineNumber)},endLine:function(){return this.addLine("")},isEmpty:function(){return this.lineArray.length<1||1==this.lineArray.length&&!this.lineArray[0]},clear:function(){this.lineArray=[],this.lastLinePrefix=""},toString:function(){return this.lineArray.join("\n")},add:function(e,t){return"string"==typeof e?this.addText(e,t):this.addLine(e,t)}};var i={end:"endLine"};for(var o in i)r.prototype[o]=r.prototype[i[o]];t.exports=n=function(e,t){return new r(e,t)},n.class=r},{}],12:[function(e,t,n){var r=0,i=function(e){this.data={},this.version={},this.updateCallback=e};i.prototype={data:null,version:null,updateCallback:null,update:function(e,t){this.data[e]=t,this.version[e]=++r,this.updateCallback&&this.updateCallback(e,t,this.version[e])},getDiff:function(e){if(!e)return{data:this.data,version:this.version};var t,n={},r=0;for(t in this.version)e[t]!==this.version[t]&&(n[t]=this.data[t],r++);return r>0?{data:n,version:this.version}:{version:this.version}}},t.exports={class:i}},{}],13:[function(e,t,n){t.exports={name:"tpsvr",version:"1.0.1",description:"test page server",main:"server/tpsvr-main.js",scripts:{test:'echo "Error: no test specified" && exit 1'},keywords:["test","http","server"],author:"fwg",license:"ISC",bin:{tpsvr:"bin/cmd.js"},repository:{type:"git",url:"git+https://github.com/adf0001/tpsvr.git"},bugs:{url:"https://github.com/adf0001/tpsvr/issues"},homepage:"https://github.com/adf0001/tpsvr#readme",dependencies:{"argv-config":"^1.0.4","browserify-stringify-minimize-css-content":"^1.0.1","bundle-collapser":"^1.4.0","delay-set-timeout":"^1.0.1","easy-http-server":"^1.0.1","htm-tool":"^1.0.15","http-request-text":"^1.0.5","multiple-spawn":"^1.0.14","open-url-by-browser":"^1.0.1","response-long-poll-state":"^1.0.4","response-tool":"^1.0.4",stringify:"^5.2.0",supervisor:"^0.12.0",terser:"^5.10.0","version-value-set":"^1.0.1",watchify:"^4.0.0"},devDependencies:{}}},{}],14:[function(e,t,n){(function(n){(function(){var r=e("fs"),i=e("path"),o={},a={},s=function(){var e,t=[];for(e in o)t[t.length]=o[e].path;t.sort();var i=n+"/../../output";r.existsSync(i)||r.mkdirSync(i),r.writeFileSync(i+"/project-list.json",JSON.stringify(t,null,"\t"))},l=function(t,n){if(!t)return Error("empty project path");var l,c=(t=i.normalize(t.replace(/[\\\/]+$/,""))).toUpperCase();if(c in a)return Error("project duplicated, "+a[c]);if(!r.existsSync(t+"/package.json"))return Error("unfound project config");try{l=e(t+"/package.json")}catch(e){}if(!l)return Error("fail to load project config");for(var u=l.name,p=2;u in o;)u=l.name+"-"+p,p++;return o[u]={name:u,path:t,config:l},a[c]=u,n||s(),o[u]};t.exports={data:o,add:l,remove:function(e,t){if(t){if(!((r=e)in o))return Error("project name unfound, "+r);var n=o[r].path.toUpperCase()}else{if(!((n=(e=i.normalize(e.replace(/[\\\/]+$/,""))).toUpperCase())in a))return Error("project unfound");var r=a[n]}return delete o[r],delete a[n],s(),r},exists:function(e){if(!e)return Error("empty project path");var t=(e=i.normalize(e.replace(/[\\\/]+$/,""))).toUpperCase();return a[t]||""},save:s,load:function(){var t=i.normalize(n+"/../../output/project-list.json");if(r.existsSync(t)){var o,a,s;try{o=e(t)}catch(e){return void console.log("load project list fail",t,e)}if(o)for(a=0;a<o.length;a++)try{(s=l(o[a],!0))instanceof Error?console.log("load project fail",o[a],s.message):console.log("load project from "+o[a])}catch(e){console.log("load project fail",o[a],e)}}}}}).call(this)}).call(this,e("path").join(__dirname,"lib"))},{undefined:void 0}],15:[function(e,t,n){(function(n){(function(){var r=e("path"),i=e(5),o=e(8),a=e(12),s=e(2),l=e(16),c=e(14),u=null,p=new a.class((function(){u=s([o.defaultEventEmitter,"state-change"],l.long_poll_state_delay,u,l.long_poll_state_delay+3e3)})),d={version:{}};var f=function(){d&&(d.data=null),p.update("sys",{dirname:r.normalize(n+"/.."),server_file_exec:l.extension_server_file_exec})};f();var h=function(){!function(e){d&&(d.data=null);var t=i.spawnItem(e),n={};for(var r in t)t[r]&&(n[r]=1);p.update(e,n)}("bundle")};h();t.exports={versionState:p,getLongPollState:function(){if(d.data)return d;var e=p.getDiff(d.version);return Object.assign(d.version,e.version),d.data=e.data,d},updateSys:f,updateBundle:h,updateProjects:function(){d&&(d.data=null);var e={};for(var t in c.data)e[t]=1;p.update("projects",e)}}}).call(this)}).call(this,e("path").join(__dirname,"lib"))},{12:12,14:14,16:16,2:2,5:5,8:8,undefined:void 0}],16:[function(e,t,n){t.exports=e("./tpsvr-config.js")},{undefined:void 0}],17:[function(e,t,n){(function(n){(function(){var r=e("url"),i=e("fs"),o=e("path"),a=e("os"),s=e(9),l=e(5),c=e(8),u=(e(7),e(13)),p=e(14),d=e(15),f=function(e,t,n){return t&&console.log(t.message||t),s.errorOrData(e,t,n),!0};function h(e,t){return i.stat(t,((n,r)=>{f(e,n,n?"":"result file, "+r.size+" bytes,\n"+o.normalize(t))})),!0}var m={getVersion:function(e,t,n){var r=p.exists(decodeURIComponent(e.reqUrl.query.cwd));return r=!r||r instanceof Error?0:1,f(t,null,u.name+", "+u.version+(n.bundle_ver?", "+n.bundle_ver.replace(/^\.+/,""):"")+", cwd="+r)},stopTpsvr:function(e,t,n){return s.text(t,"tpsvr stopping ..."),setTimeout((function(){process.ppid&&"by-supervisor"in n&&(console.log("killing parent process ..."),process.kill(process.ppid)),process.exit(0)}),200),!0},addProject:function(e,t,n){var r=p.add(decodeURIComponent(e.reqUrl.query.path));return!r||r instanceof Error?f(t,r||"add project fail"):(console.log("add project "+r.name+", "+r.path),d.updateProjects(),f(t,null,r))},removeProject:function(e,t,n){var r;return e.reqUrl.query.path?r=p.remove(decodeURIComponent(e.reqUrl.query.path)):e.reqUrl.query.name&&(r=p.remove(decodeURIComponent(e.reqUrl.query.name),!0)),!r||r instanceof Error?f(t,r||"remove project fail"):(l.remove(["bundle",r]),d.updateProjects(),f(t,null,r))},listProject:function(e,t,n){var r=e.reqUrl.query.project;return r?r in p.data?f(t,null,p.data[r]):f(t,"project unfound, "+r):f(t,null,p.data)},startBundle:function(e,t,r){var a=decodeURIComponent(e.reqUrl.query.project),s=p.data[a];if(!s)return f(t,"project unfound, "+a);var c=s.path+"/test/test-bundle.bat",u=null,h=!1;if(!i.existsSync(c)){if(!i.existsSync(s.path+"/test/test-data.js"))return f(t,"files unfound, test-bundle.bat, test-data.js, "+a);h=!0,i.existsSync(s.path+"/test")||i.mkdirSync(s.path+"/test"),i.existsSync(s.path+"/test/bundle")||i.mkdirSync(s.path+"/test/bundle"),c=o.normalize(n+"/../node_modules/.bin/watchify"),u=["-v ","-o",s.path+"/test/bundle/test-bundle.js","-g","[ stringify --extensions [.html .css .htm ] ]","-r",s.path+"/package.json:_package_json","-r",s.path+"/test/test-data.js:_test_data","-r",s.path+"/"+s.config.main+":"+a]}var m=l.start(["bundle",a],c,u,{shell:h,keepHistoryConsole:!0},(function(e){d.updateBundle()}));return f(t,!m||m instanceof Error?m||"start bundle fail":null,!!m)},stopBundle:function(e,t,n){var r=decodeURIComponent(e.reqUrl.query.project),i=l.stop(["bundle",r]);return f(t,!i||i instanceof Error?i||"stop bundle fail":null,i)},viewConsole:function(e,t,n){var r=decodeURIComponent(e.reqUrl.query.project),i=["bundle",r],o="1"==e.reqUrl.query.history;"1"==e.reqUrl.query.clearHistory&&l.historyConsole(i,null);var a=l.getConsole(i,o);if(a instanceof Error)return f(t,a||"get console fail");if(null===a&&!o&&(o=!0,(a=l.getConsole(i,o))instanceof Error))return f(t,a||"get history console fail");var c=!0;null===a?a="(not exists, ["+i+"])":a?c=!1:a="(void, ["+i+"])";var u=["<div style='font-size:9pt;'>",o&&!c?"<a style='float:right;' href='/?cmd=viewConsole&project="+encodeURIComponent(r)+"&clearHistory=1'>[clear history]</a><br>":"",o?"":"<a style='float:right;' href='/?cmd=viewConsole&project="+encodeURIComponent(r)+"&history=1'>[history]</a><br>",a.replace(/^\s+/,"").replace(/\n\n\n+/g,"\n\n").replace(/\n/g,"<br>"),"</div>"];return s.text(t,u.join(""),null,{"Content-Type":"text/html;charset=UTF-8"}),!0},getLongPollState:function(e,t,n){if("1"==e.reqUrl.query.current)c.getCurrent(t,d.versionState.getDiff());else if(e.reqUrl.query.state_version){var r=decodeURIComponent(e.reqUrl.query.state_version);try{r=JSON.parse(r)}catch(e){return f(t,"state version fail, "+e.message)}var i=d.versionState.getDiff(r);i.data?c.getCurrent(t,JSON.stringify(i)):c(t,d.getLongPollState)}else c(t,d.getLongPollState);return!0},createTestData:function(e,t,r){var o=decodeURIComponent(e.reqUrl.query.project),a=p.data[o];if(!a)return f(t,"project unfound, "+o);if(i.existsSync(a.path+"/test/test-data.js"))return f(t,"file already exists, test/test-data.js, "+o);var s=i.readFileSync(n+"/../client/root/res/test-data-template.js","utf-8");return s=s.replace(/package-main-file/g,a.config.main).replace(/package_name_var/g,a.config.name.replace(/\W/g,"_")),i.existsSync(a.path+"/test")||i.mkdirSync(a.path+"/test"),i.writeFileSync(a.path+"/test/test-data.js",s),h(t,a.path+"/test/test-data.js")},createTestHtm:function(e,t,r){var o=decodeURIComponent(e.reqUrl.query.project),a=p.data[o];return a?i.existsSync(a.path+"/test/test.htm")?f(t,"file already exists, test/test.htm, "+o):(i.existsSync(a.path+"/test")||i.mkdirSync(a.path+"/test"),i.copyFileSync(n+"/../client/root/res/test-template.htm",a.path+"/test/test.htm"),h(t,a.path+"/test/test.htm")):f(t,"project unfound, "+o)},createBundleTool:function(e,t,r){var s=decodeURIComponent(e.reqUrl.query.project),l=p.data[s];if(!l)return f(t,"project unfound, "+s);if(i.existsSync(l.path+"/test/test-bundle.bat"))return f(t,"file already exists, test/test-bundle.bat, "+s);var c=i.readFileSync(n+"/res/test-bundle-template.bat","utf-8");return c=c.replace(/\%tpsvrPath\%/g,o.normalize(n+"/..")).replace(/\%moduleName\%/g,l.config.name).replace(/\%moduleMainFile\%/g,l.config.main),"Windows_NT"===a.type()&&(c=c.replace(/(\r\n|\n\r|\n|\r)/g,"\r\n")),i.existsSync(l.path+"/test")||i.mkdirSync(l.path+"/test"),i.writeFileSync(l.path+"/test/test-bundle.bat",c,"utf8"),h(t,l.path+"/test/test-bundle.bat")},tryMinimizeBundle:function(e,t,r){var a=decodeURIComponent(e.reqUrl.query.project),s=p.data[a];if(!s)return f(t,"project unfound, "+a);var c=s.path+"/test/main-minimize.bat",u=null,d=!0,m=!1;i.existsSync(c)||(d=!1,m=!0,i.existsSync(s.path+"/test")||i.mkdirSync(s.path+"/test"),i.existsSync(s.path+"/test/bundle")||i.mkdirSync(s.path+"/test/bundle"),c=o.normalize(n+"/../node_modules/.bin/browserify"),u=["-v ","-o",s.path+"/test/bundle/main-bundle-minimized.js","-p","bundle-collapser/plugin","-g","[ browserify-stringify-minimize-css-content --minimizeExtensions [ .css ] ]","-g","[ stringify --extensions [.html .css .htm ] --minify true ]","-r",s.path+"/"+s.config.main+":"+a]);var v=["minimize",a],y=l.start(v,c,u,{shell:m,keepHistoryConsole:!0},(function(e){if("exit"==e){var r=l.historyConsole(v);if(r&&l.historyConsole(["bundle",a],r),l.remove(v),d)return void h(t,s.path+"/test/bundle/main-bundle-minimized.js");if(c=o.normalize(n+"/../node_modules/.bin/terser"),u=[s.path+"/test/bundle/main-bundle-minimized.js","-o",s.path+"/test/bundle/main-bundle-minimized.js","-c","-m"],y=l.start(v,c,u,{shell:m,keepHistoryConsole:!0},(function(e){if("exit"==e){var n=l.historyConsole(v);n&&l.historyConsole(["bundle",a],n),l.remove(v),h(t,s.path+"/test/bundle/main-bundle-minimized.js")}})),y instanceof Error)return f(t,y||"start minimize bundle fail, terser")}}));return!(y instanceof Error)||f(t,y||"start minimize bundle fail, browserify")},createMiniBundleTool:function(e,t,r){var s=decodeURIComponent(e.reqUrl.query.project),l=p.data[s];if(!l)return f(t,"project unfound, "+s);if(i.existsSync(l.path+"/test/main-minimize.bat"))return f(t,"file already exists, test/main-minimize.bat, "+s);var c=i.readFileSync(n+"/res/main-minimize-template.bat","utf-8");return c=c.replace(/\%tpsvrPath\%/g,o.normalize(n+"/..")).replace(/\%moduleName\%/g,l.config.name).replace(/\%moduleMainFile\%/g,l.config.main),"Windows_NT"===a.type()&&(c=c.replace(/(\r\n|\n\r|\n|\r)/g,"\r\n")),i.existsSync(l.path+"/test")||i.mkdirSync(l.path+"/test"),i.writeFileSync(l.path+"/test/main-minimize.bat",c,"utf8"),h(t,l.path+"/test/main-minimize.bat")},getClientBundle:function(e,t,r){var o=Object.create(r);return o.filePath=n+"/../client/root/bundle-client.debug.js",i.existsSync(o.filePath)||(o.filePath=n+"/../client/root/bundle-client.minimized.js"),o.isRoot=!1,r.default_process(e,t,o),!0}},v=!1;t.exports=function(e,t,a){v||(p.load(),v=!0,d.updateProjects()),t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET"),t.setHeader("Access-Control-Allow-Headers","x-requested-with,content-type");var l=r.parse(e.url,!0),c=decodeURIComponent(l.pathname).match(/^\/([^\*\/]+)\/\*\/(.*$)/);if(c)return function(e,t,r,a,l){var c=p.data[e];if(!c)return f(a,"project unfound, "+e);var u=Object.create(l);if(u.filePath=c.path+"/"+t,u.isRoot=u.filePath.replace(/[\\\/]+$/,"")==c.path,"test/test.htm"===t&&!i.existsSync(u.filePath)){if(!i.existsSync(o.dirname(u.filePath)+"/test-data.js"))return s.text(a,"(file not exists, 'test/test-data.js', project "+e+")");u.filePath=n+"/../client/root/res/test-template.htm"}l.default_process(r,a,u)}(c[1],c[2],e,t,a),!0;if("/"===l.pathname){var u=l.query;if(!u||!u.cmd){var h=Object.create(a);return h.filePath=n+"/../client/root/index.html",a.default_process(e,t,h)}return u.cmd in m?(e.reqUrl=l,console.log("cmd="+u.cmd+", "+decodeURIComponent(l.search)),m[u.cmd](e,t,a)):f(t,"cmd unfound, "+u.cmd)}}}).call(this)}).call(this,e("path").join(__dirname,"."))},{13:13,14:14,15:15,5:5,7:7,8:8,9:9,undefined:void 0}],18:[function(e,t,n){(function(t){(function(){var n=e("fs"),r=e("path"),i=e(4),o=e(1),a=e(16),s=e(17),l=o({},null,null);l.cwd&&(l=o({},null,l.cwd));var c,u=l.cwd||process.cwd();if(console.log(u,t),u!==t){var p=u+"/tpsvr-config.js";if(n.existsSync(p))try{console.log("try loading user config ..."),c=e(p)}catch(e){console.log("userConfig fail",e)}}var d=Object.assign({},a,c||{},l);d.extension&&d.extension instanceof Array?d.extension.push(s):d.extension=[s],d.root_path=r.normalize(t+"/../client/root"),i(d)}).call(this)}).call(this,e("path").join(__dirname,"."))},{1:1,16:16,17:17,4:4,undefined:void 0}]},{},[18]);